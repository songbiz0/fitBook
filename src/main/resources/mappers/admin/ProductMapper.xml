<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fitbook.admin.AdminMapper">
    <sql id="searchIf">
        <where>
            B.isrep = 'Y'
            <if test="select != null">
                AND (B.isrep = 'Y' AND ${select} LIKE CONCAT('%',#{search},'%'))
            </if>
            <if test="total != null">
                OR(B.isrep = 'Y' AND ${total} LIKE CONCAT('%',#{search},'%'))
            </if>
        </where>
    </sql>

    <select id="selProductList" resultType="ProductVo">
        SELECT * FROM (
        SELECT ROW_NUMBER() OVER(ORDER BY B.rdt) AS num , A.iproduct, A.nm, A.product_code,A.brand,
        B.img, B.price, B.idetail, C.stock, F.master_total
        FROM t_product_master A
        INNER JOIN t_product_detail B
        ON A.iproduct = B.iproduct
        INNER JOIN (
            SELECT SUM(stock) AS stock,iproduct
            FROM t_product_detail
            GROUP BY iproduct
            )C
         ON C.iproduct = A.iproduct
        INNER JOIN (
        SELECT ifnull(SUM(result_price), 0) AS master_total, D.iproduct
        FROM t_product_detail D
        LEFT JOIN t_order_product E
        ON D.idetail = E.idetail
        WHERE D.iproduct
        GROUP BY D.iproduct
        ) F
        ON F.iproduct = A.iproduct
         <include refid="searchIf">

         </include>
        ORDER BY num DESC
        LIMIT ${startIdx}, ${recordCount} ) AS t
    </select>

    <select id="selMaxPageVal" resultType="resultVo">
        SELECT CEIL((count(A.iproduct)) / ${recordCount}) AS result
        FROM t_product_master A
        INNER JOIN t_product_detail B
        ON A.iproduct = B.iproduct
        WHERE isrep = 'Y'
    </select>

    <select id="selProductDetail" resultType="ProductVo">
        SELECT B.price, B.ssd, B.hdd, B.color, A.rdt, B.stock
        FROM t_product_master A
                 INNER JOIN t_product_detail B
                            ON A.iproduct = B.iproduct
                 INNER JOIN t_product_cpu C
                            ON A.icpu = C.icpu
                 INNER JOIN t_product_gpu D
                            ON A.igpu = D.igpu
        WHERE A.iproduct = ${iproduct}
        ORDER BY isrep DESC;
    </select>

    <select id="selProductDetail2" resultType="ProductVo">
        SELECT A.product_code, A.nm, A.rdt, A.brand, A.ram, A.size, A.weight, A.os,
               B.idetail, C.nm AS cpu, D.nm AS gpu,  B.img
        FROM t_product_master A
        INNER JOIN t_product_detail B
            ON A.iproduct = B.iproduct
        INNER JOIN t_product_cpu C
            ON A.icpu = C.icpu
        INNER JOIN t_product_gpu D
            ON A.igpu = D.igpu
        WHERE B.isrep = 'Y'
            AND A.iproduct = ${iproduct};
    </select>

    <insert id="insProductMaster" useGeneratedKeys="true" keyProperty="iproduct" keyColumn="iproduct">
        INSERT INTO t_product_master
        (nm, product_code, rdt, icpu, igpu, ram, size, weight, brand, os, img)
        VALUES
        (#{nm}, #{product_code}, #{rdt}, ${icpu}, ${igpu}, ${ram}, ${size}, ${weight}, #{brand}, #{os}, #{img})
    </insert>

    <insert id="insProductDetail" useGeneratedKeys="true" keyProperty="idetail" keyColumn="idetail">
        INSERT INTO t_product_detail
        (iproduct, color, hdd, ssd, price, stock, isrep, dc_rate, img)
        VALUES
        (${iproduct}, #{color}, ${hdd}, ${ssd}, ${price}, ${stock}, #{isrep}, ${dc_rate}, #{img})
    </insert>
</mapper>